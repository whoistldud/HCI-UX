<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">

        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>HCI-Prototype</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
        <style>
          .autocomplete > div.active {
                background: #e0e5f6;
                color: #000;
              }

              .autocomplete > div {
                background: #f1f3f499;
                padding: .2rem .6rem;
              }

              section {
                width: 500px;
                padding: 1.5rem 1.6rem;
                box-shadow: 0 0 1rem rgba(0, 0, 0, .05);  
                border-radius: 5px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                background: #fff;
                margin-top: 2rem;
              }

              @import url("https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css");

              * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                outline: none;
                word-break: break-all;
                font-family: Pretendard;
              }


              mark {
                background: #77bdff90;
              }
        </style>
        <script
        src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
      </head>
  <body>
    <!-- <nav class="navbar bg-body-tertiary mb-3 ">
        <div class="container-fluid">
          <span class="navbar-brand mb-0">HCI</span>
        </div>
      </nav> -->
      <div class="container-fluid" >
        <div class="row" >
          <div class="col mt-1" style="background-color: ;">            
            <div class="row mb-2">
                <div class="col">
                    <!-- 사용자 기본 인적사항 작성 부분 -->
            <div class="border border-light-subtle mb-3" style="border-radius: 10px; padding: 10px;">
              <div class="row mb-2">
                <div class="col">
                    <div class="mb-3">
                        <label  for="InputName" class="form-label">이름</label>
                        <input type="text" class="form-control" id="InputName" 
                        placeholder="이름을 입력해주세요">
                    </div>
                   
                    </div>
                    <div class="col">
                        <div class="mb-3">
                            <label  for="InputNum" class="form-label">학번</label>
                            <input type="text" class="form-control" id="InputNum" 
                            placeholder="학번을 입력해주세요">
                        </div>
                    </div>
                    <div class="col">
                        <div class="mb-3">
                            <label  for="InputMajor" class="form-label">전공</label>
                            <input type="text" class="form-control" id="InputMajor" 
                            placeholder="전공을 입력해주세요">
                        </div>
                    </div>
                  </div>
                  <div class="row">
                      <div class="col">
                          <div class="mb-3">
                              <label  for="InputLecture" class="form-label">강의명</label>
                              <input type="text" class="form-control" id="InputLecture" 
                              placeholder="강의명을 입력해주세요">
                          </div>
                      </div>
                      <div class="col">
                          <div class="mb-3">
                              <label  for="InputToName" class="form-label">받는 사람</label>
                              <input type="text" class="form-control" id="InputToName" 
                              placeholder="받는 사람의 이름을 입력해주세요">
                          </div>
                      </div>
                      <div class="col">
                          <div class="mb-3">
                              <label  for="InputEmail" class="form-label">&nbsp; </label>
                              <input type="email" class="form-control" id="InputEmail" 
                              placeholder="받는 사람의 이메일을 입력해주세요">
                          </div>
                      </div>
                  </div>
                
            </div>
            <label for="speaking" style="font-size: 1.2em;" class="mb-3">메일 양식 언어</label>
            <div class="row mb-4" id="speaking">
                <div class="btn-group" role="group" aria-label="Basic radio toggle button group">
                  <input type="radio" class="btn-check" name="btnradio" id="btnradio1" autocomplete="off" checked>
                  <label class="btn btn-outline-secondary" for="btnradio1">한국어</label>
                
                  <input type="radio" class="btn-check" name="btnradio" id="btnradio2" autocomplete="off">
                  <label class="btn btn-outline-secondary" for="btnradio2">영어</label>
                </div>
            </div>
            <!-- <label for="language" style="font-size: 1.2em;" class="mb-3">언어</label>
            <div class="row mb-4" id="language">
                <div class="btn-group" role="group" aria-label="Basic radio toggle button group">
                  <input type="radio" class="btn-check" name="btnradio" id="btnradioKor" autocomplete="off" checked>
                  <label class="btn btn-outline-secondary" for="btnradioKor">한국어</label>
                
                  <input type="radio" class="btn-check" name="btnradio" id="btnradioEng" autocomplete="off">
                  <label class="btn btn-outline-secondary" for="btnradioEng">영어</label>
                </div>
            </div> -->

            <label for="situationSelect" class="mb-3" style="font-size: 1.2em;">상황</label>
            <div class="row mb-4" id="situationSelect">
                <div class="col">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="flexRadioDefault" id="grade" checked>
                    <label class="form-check-label" for="flexRadioDefault1">
                      성적 문의
                    </label>
                  </div>
                </div>
                <div class="col">
                  <div class="form-check">
                      <input class="form-check-input" type="radio" name="flexRadioDefault" id="attend" >
                      <label class="form-check-label" for="flexRadioDefault1">
                        출석 문의
                      </label>
                    </div>
                </div>
                <div class="col">
                  <div class="form-check">
                      <input class="form-check-input" type="radio" name="flexRadioDefault" id="enrolment" >
                      <label class="form-check-label" for="flexRadioDefault1">
                        수강 신청 관련 문의
                      </label>
                    </div>
                  </div>
                <div class="col">
                  <div class="form-check">
                      <input class="form-check-input" type="radio" name="flexRadioDefault" id="etc" >
                      <label class="form-check-label" for="flexRadioDefault1">
                        기타
                      </label>
                    </div>
                </div>

            </div>

            <label for="detail" class="form-label" style="font-size: 1.2em;">세부 사항 입력</label>
            <div class="input-group ">
              <input id="search" type="text" class="form-control"  placeholder="세부 사항을 입력해주세요" aria-describedby=""
              autocomplete="off" >
              <button onclick="onclick_forchat()" class="btn btn-outline-primary" type="button" id="moreDetailChat">
                  완료
              </button>
          </div>
          <!--자동완성 목록 뜨는 영역-->
          <div class="autocomplete"></div>

          <!--챗봇 페이지 불러오는 영역-->
          <div class="mt-3" style="font-size:small;">
                    <span id="chatArea"></span>
          </div>
          </div>
          
          
          <div class="col mt-1">
            <div class="">
              <label for="mailSubject" class="form-label"></label>
              <textarea class="form-control" id="mailSubject" rows="2"
              placeholder="제목" style="font-size: 1.2em;"></textarea>
            </div>
            <div class="mb-3">
              <label for="mailContent" class="form-label"></label>
              <textarea class="form-control" id="mailContent" rows="27"></textarea>
            </div>

            <button type="button" class="btn btn-info btn-lg" onclick="sendEmail()" style="width: 300px; float: right; margin-left: 15px;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-send" viewBox="0 0 16 16">
                <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"/>
              </svg> 전송하기</button>
            <button type="button" class="btn btn-secondary btn-lg" style="width: 300px; float: right;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-repeat" viewBox="0 0 16 16">
                <path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"/>
                <path fill-rule="evenodd" d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"/>
              </svg>  재작성</button>
            
          </div>
        </div>
      </div>
      <script>

        /* 자동완성 코드*/
        const dataList = ["지하철", "지하철 파업", "출석", "출석 인정", "병결", "결석",
        "철도노조", "연착", "증명서", "지연", "지각", "인정", "행사", "필수 참석", "확인서", "예비군", "예비군 훈련", "기말고사", "시험", "입원",
        "수술", "성적", "성적 세부 사항", "시험지 확인", "태도 점수", "깎인 이유", "감점 이유", "비협조", "비협조적인 팀원", "팀원의 비협조적인 태도",
        "세부 점수"];

        const $search = document.querySelector("#search");
        const $autoComplete = document.querySelector(".autocomplete");
  
        let nowIndex = 0;
        let matchDataList = [];
  
        $search.addEventListener("input", (event) => {
          // 입력된 문장을 공백으로 분리
          const words = $search.value.trim().split(/\s+/);
  
          // 현재 입력 중인 단어
          const currentWord = words[words.length - 1];
  
          // 현재 입력 중인 단어의 첫 글자에 대한 자동완성 필터링
          matchDataList = currentWord
            ? dataList.filter((label) => label.startsWith(currentWord))
            : [];
  
          // 각 단어에 대해 자동완성 결과 생성 및 표시
          showList(matchDataList, currentWord, nowIndex);
        });
  
        $search.addEventListener("keydown", (event) => {
          switch (event.keyCode) {
            // UP KEY
            case 38:
              nowIndex = Math.max(nowIndex - 1, 0);
              break;
  
            // DOWN KEY
            case 40:
              nowIndex = Math.min(nowIndex + 1, matchDataList.length - 1);
              break;
          }
  
          // 화면에 표시된 자동완성 단어 강조 표시
          updateActiveItem(nowIndex);
        });
  
        $search.addEventListener("keyup", (event) => {
          if (event.keyCode === 13) {
            // 엔터 키
            event.preventDefault(); // textarea에서의 엔터 키 기본 동작을 막음
  
            const words = $search.value.trim().split(/\s+/);
  
            // 현재 입력 중인 단어에 대한 자동완성이 선택된 경우
            if (matchDataList.length > 0) {
              words[words.length - 1] = matchDataList[nowIndex] || "";
              $search.value = words.join(" ");
  
              // 자동완성 결과 및 인덱스 초기화
              $autoComplete.innerHTML = "";
              nowIndex = 0;
            }
  
            // 초기화
            nowIndex = 0;
            matchDataList.length = 0;
          }
        });
  
        const showList = (data, currentWord, nowIndex) => {
          $autoComplete.innerHTML = data
            .map(
              (label, index) => `
                <div class='${nowIndex === index ? "active" : ""}'>
                  ${label.replace(new RegExp(`(${currentWord})`, "g"), "<mark>$1</mark>")}
                </div>
              `
            )
            .join("");
        };
  
        const updateActiveItem = (index) => {
          const items = $autoComplete.querySelectorAll(".autocomplete > div");
          items.forEach((item, i) => {
            if (i === index) {
              item.classList.add("active");
            } else {
              item.classList.remove("active");
            }
          });
        };
        /**/



        // 이메일을 보낼 때 필요한 정보(이메일, 제목, 내용)를 서버로 전달하는 함수
        function sendEmail() {
            const toEmail = document.getElementById('InputEmail').value;
            const title = document.getElementById('mailSubject').value;
            const body = document.getElementById('mailContent').value;

            fetch('/send-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    toEmail,
                    title,
                    body,
                }),
            })
            .then(response => response.json())
            .then(data => {
                console.log('이메일 전송 결과:', data);
                // 메일 전송 완료 시 뜨는 alert
                alert("메일이 전송되었습니다.")
            })
            .catch(error => {
                console.error('이메일 전송 중 오류 발생:', error);
            });
        }
        document.getElementById("moreDetailChat").addEventListener("mouseup", function() {
          onclick_forchat();
        });
        var name, studentId, major, lecture, recipientName, recipientEmail, language;
        var mailSubjectTextarea, mailContentTextarea;
        function onclick_forchat (){
          
          name = document.getElementById('InputName').value;
          console.log("inputName:",name);
          studentId = document.getElementById('InputNum').value;
          major = document.getElementById('InputMajor').value;
          lecture = document.getElementById('InputLecture').value;
          recipientName = document.getElementById('InputToName').value;
          recipientEmail = document.getElementById('InputEmail').value;
          const situ = document.getElementById("search").value;
          language = document.querySelector('input[name="btnradio"]:checked').id === 'btnradio1' ? '한국어' : '영어';


          // 입력한 세부 상황에 따라 다른 챗봇 파일 불러오도록 하기 위한 switch문
          $("#moreDetailChat").click(function() {  // '완료' 버튼 클릭 시 실행되는 코드
            if (situ.includes("지하철")){
              loadMoreDetail("moreDetail1.html");

            }
            else if (situ.includes("예비군")){
              loadMoreDetail("moreDetail.html");
            }
            else if (situ.includes("시험지 확인")){
              loadMoreDetail("moreDetail2.html");
            }
          
      });

        // html파일 url 받아서 ajax로 뿌려주는 함수
        function loadMoreDetail(url) {
            $.ajax({
                url: url,
                success: function(result) {
                    $("#chatArea").html(result);
                    var elementValue = $("#mailContent").text();
                    window.parent.postMessage({ idValue: elementValue }, '*');
                    
                },
                error: function(request, status, error) {
                    console.log("code: " + request.status);
                    console.log("message: " + request.responseText);
                    console.log("error: " + error);
                }
            });
        }

          }
    
      </script>
  </body>
  
</html>